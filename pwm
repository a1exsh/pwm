#!/bin/sh
fatal() {
    echo "$*" >&2
    exit 1
}

rcfile=~/.pwmrc
if [ -f "$rcfile" ]; then
    [ $(stat -c'%a' "$rcfile") = 600 ] || fatal "Access mode on \`$rcfile' is too permissive: please set to 600."
    . "$rcfile"
fi
[ -n "$cipher" ] || cipher=-aes256
[ -n "$dbfile" ] || dbfile=~/.pwmdb
[ -n "$default_pwlen" ] || default_pwlen=30
[ -n "$EDITOR" ] || EDITOR=vi
umask 177

if [ -f "$dbfile" ]; then
    [ $(stat -c'%a' "$dbfile") = 600 ] || fatal "Access mode on password database \`$dbfile' is too permissive: please set to 600."
fi

type openssl 2>/dev/null >&2 || fatal "OpenSSL suite is required to use Password Manager."

set -e

backup_db() {
    cp "$dbfile" "${dbfile}~"
}

encrypt() {
    ( echo "$masterpw"; cat ) | openssl enc "$cipher" -salt -pass stdin >"$dbfile"
}

decrypt() {
    if [ -f "$dbfile" ]; then
        ( echo "$masterpw"; cat "$dbfile" ) | openssl enc "$cipher" -d -pass stdin
    else
        echo -n ""
    fi
}

read_masterpw() {
    stty -echo
    prompt="$1"
    [ -n "$prompt" ] || prompt="master password"
    read -p "${prompt}: "  masterpw; echo
    stty echo
}

create_tempfile() {
    tempfile -p .pwm -d "$HOME"
}

read_key() {
    read -p "$*: " key
}

lookup() {
    db=$(decrypt)
    echo "$db" | grep "${key}[^:]*:"
}

add_password() {
    db=$(decrypt)
    tmp=$(create_tempfile)
    trap "rm -f -- '$tmp'" EXIT
    ( echo "$db"; echo "${key}:${pw}" ) | dbfile="$tmp" encrypt
    backup_db
    mv "$tmp" "$dbfile"
    echo "password stored"
}

echo "Password Manager"
echo "l) Lookup password"
type xclip 2>/dev/null >&2 && echo "x) Copy password to X clipboard (using xclip command)"
echo "a) Add password"
echo "g) Generate password"
echo "e) Edit password database ($dbfile)"
echo "m) Change master password"
echo "q) Quit"
while true; do
    read -p "> " action
    case "$action" in
        l)
            read_key "lookup key"
            read_masterpw
            lookup
            ;;
        x)
            read_key "key to copy"
            read_masterpw
            lookup | head -n1 | cut -d: -f2 | tr -d '\n' | xclip -in -verbose -selection clipboard
            ;;
        a)
            read_key "key to add"
            stty -echo
            read -p "password to store: " pw; echo
            stty echo
            read_masterpw
            add_password
            ;;
        g)
            read_key "key to add"
            read -p "password length ($default_pwlen): " pwlen
            [ "$pwlen" = "$(echo)" ] && pwlen="$default_pwlen"
            pw=$(openssl rand -base64 "$pwlen" | tr -d '\n=' | cut -b-"$pwlen")
            read_masterpw
            add_password
            ;;
        e)
            read_masterpw
            tmp=$(create_tempfile)
            trap "rm -f -- '$tmp'" EXIT
            decrypt >"$tmp"
            "$EDITOR" "$tmp"
            backup_db
            encrypt <"$tmp"
            echo "password database updated"
            ;;
        m)
            read_masterpw
            old_masterpw="$masterpw"
            read_masterpw "new master password"
            new_masterpw="$masterpw"
            read_masterpw "confirm new master password"
            [ "$new_masterpw" = "$masterpw" ] || fatal "Confirmation doesn't match new master password: operation aborted."
            db=$(masterpw="$old_masterpw" decrypt)
            backup_db
            echo "$db" | encrypt
            echo "master password updated"
            ;;
        q) echo "Bye!";;
        *) continue;;
    esac
    exit 0
done
